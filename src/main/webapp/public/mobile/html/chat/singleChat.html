<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
<title>chat</title>
<meta name="description" content="">
<meta name="keywords" content="">
<link href="../../css/reset.css" rel="stylesheet">
<link href="../../css/style.css" rel="stylesheet">
<link href="../../css/common.css" rel="stylesheet">
<script src="../../js/jquery.min.js" type="text/javascript"></script>
<script src="../../js/api.js" type="text/javascript"></script>
<script src="../../js/apibase.js" type="text/javascript"></script>
<script src="../../js/common.js" type="text/javascript"></script>
</head>
<body>
        <ul class="chatList ing">
            <li class="Y">
                <div class="A">
                    <span>船</span>
                </div>
                <div class="B">
                    <strong>新船</strong>
                    <p>你瞅啥？</p>
                </div>
            </li>
            <li class="M">
                <div class="B">
                    <strong>御龙</strong>
                    <p>瞅你咋地~</p>
                </div>
                <div class="A">
                    <span>龙</span>
                </div>
            </li>
            <li class="Y">
                <div class="A">
                    <span>船</span>
                </div>
                <div class="B">
                    <strong>新船</strong>
                    <p>再瞅一个试试~</p>
                </div>
            </li>
            <li class="M">
                <div class="B">
                    <strong>御龙</strong>
                    <p>试试<br>就试试~</p>
                </div>
                <div class="A">
                    <span>龙</span>
                </div>
            </li>
            <li class="T">
                <div class="time">2015-11-16</div>
            </li>
            <li class="Y">
                <div class="A">
                    <span>船</span>
                </div>
                <div class="B">
                    <strong>新船</strong>
                    <p>你瞅啥？</p>
                </div>
            </li>
            <li class="M">
                <div class="B">
                    <strong>御龙</strong>
                    <p>瞅你咋地~</p>
                </div>
                <div class="A">
                    <span>龙</span>
                </div>
            </li>
            <li class="Y">
                <div class="A">
                    <span>船</span>
                </div>
                <div class="B">
                    <strong>新船</strong>
                    <p>再瞅一个试试~</p>
                </div>
            </li>
            <li class="M">
                <div class="B">
                    <strong>御龙</strong>
                    <p><img src="../images/2.jpg" class="face"><img src="../images/1.jpg">试试<br>就试试~就试试~就试试~就试试~就试试~就试试~就试试~就试试~就试试~就试试~</p>
                </div>
                <div class="A">
                    <span>龙</span>
                </div>
            </li>
            
            <li class="Y">
                <div class="A">
                    <span>船</span>
                </div>
                <div class="B">
                    <strong>新船</strong>
                    <p>你瞅啥？</p>
                </div>
            </li>
            <li class="M">
                <div class="B">
                    <strong>御龙</strong>
                    <p>瞅你咋地~</p>
                </div>
                <div class="A">
                    <span>龙</span>
                </div>
            </li>
            <li class="Y">
                <div class="A">
                    <span>船</span>
                </div>
                <div class="B">
                    <strong>新船</strong>
                    <p>再瞅一个试试~</p>
                </div>
            </li>
            <li class="M">
                <div class="B">
                    <strong>御龙</strong>
                    <p>试试<br>就试试~</p>
                </div>
                <div class="A">
                    <span>龙</span>
                </div>
            </li>
            <li class="T">
                <div class="time">2015-11-16</div>
            </li>
            <li class="Y">
                <div class="A">
                    <span>船</span>
                </div>
                <div class="B">
                    <strong>新船</strong>
                    <p>你瞅啥？</p>
                </div>
            </li>
            <li class="M">
                <div class="B">
                    <strong>御龙</strong>
                    <p>瞅你咋地~</p>
                </div>
                <div class="A">
                    <span>龙</span>
                </div>
            </li>
            <li class="Y">
                <div class="A">
                    <span>船</span>
                </div>
                <div class="B">
                    <strong>新船</strong>
                    <p>再瞅一个试试~</p>
                </div>
            </li>
            <li class="M">
                <div class="B">
                    <strong>御龙</strong>
                    <p><img src="../images/2.jpg" class="face"><img src="../images/1.jpg">试试<br>就试试~就试试~就试试~就试试~就试试~就试试~就试试~就试试~就试试~就试试~</p>
                </div>
                <div class="A">
                    <span>龙</span>
                </div>
            </li>
        </ul>
<script type="text/javascript">
apiready=function(){
	initChatBox();
	setTimeout(_scrollToEnd,500);
	api.addEventListener({
	    name: 'recvMsg'
	}, function(ret){
	    if(ret && ret.value){
	        onRecvMsg(ret.value.content);
	    }
	});
};

/* Hv action */
function setHvData(name,value){
    if(window.localStorage){
        localStorage.setItem(name,value);
    }else{
        alert('不支持？');
    }
}
function getHvData(name){
    if(window.localStorage){
        return localStorage.getItem(name);
    }else{
        alert('不支持？');
    }
}
function reHvData(name){
    if(window.localStorage){
        return localStorage.removeItem(name);
    }else{
        alert('不支持？');
    }
}
/* 实时备份输入框内容 */
function contentIndexIng(){
    $('.content').on('input',function(){
        setHvData('me-you',$(this).html())
    })
}

/* 聊天功能  */
var myName='御龙',
myFace='龙',
youName='',
youFace='';
function setSendMsg(v){
	v = v.replace(/div/g ,'span')
var str='<li class="M">'
    +'<div class="B">'
    +'<strong>'
    +myName
    +'</strong>'
    +'<p>'
    +v
    +'</p>'
    +'</div>'
    +'<div class="A">'
    +'<span>'
    +myFace
    +'</span>'
    +'</div>'
    +'</li>';
    return str;
}

function onRecvMsg(text){
	var tmp = $('.recvTemplate');
	var li = $(tmp.html());
	li.find('.msg').text(text);
	$('.chatList').append(li);
	_scrollToEnd();
}
function doSendMsg(html){
	html = htmlEncode(html);
	var li = setSendMsg(html);
	$('.chatList').append(li);
	_scrollToEnd();
	sendMsgToServer(html);
}

function sendMsgToServer(msg){
	var url ='http://'+server_host+'/c/admin/chat/sendSingleChatMsg';
	YW.ajax({
		url: url,
		method:'post',
		data:{
        	values: {buddyAccount:api.pageParam.account , msg : msg}
    	},
		cache:false,
		returnAll:false
	},function(ret , err){
		if(ret && ret.result==0){
				
		}else{
			alert(ret.msg);
		}
	});
}

//重新调整frame会话区域
function setChatInit(frameName, inputAreaHeight) {
	var headerOffset = 50;
	var h = api.winHeight - headerOffset - inputAreaHeight;
	//h=101;
	api.setFrameAttr({
		name : 'singleChatFrame',
		rect : {
			x : 0,
			y : headerOffset,
			w : api.winWidth,
			h : h
		}
	});
	setTimeout(function() {
		_scrollToEnd();
	}, 300);
}

function initChatBox(){
	var chatBox = api.require('UIChatBox');
	chatBox.open({
	    placeholder: '',
	    maxRows: 4,
	    emotionPath: 'widget://image/emotion',
	    texts: {
	        recordBtn: {
	            normalTitle: '按住 说话2',
	            activeTitle: '松开 结束'
	        }
	    },
	    styles: {
	        inputBar: {
	            borderColor: '#d9d9d9',
	            bgColor: '#f2f2f2'
	        },
	        inputBox: {
	            borderColor: '#B3B3B3',
	            bgColor: '#FFFFFF'
	        },
	        emotionBtn: {
	            normalImg: api.fsDir+'/images/chat/chat-emotion.png'
	        },
	        extrasBtn: {
	            normalImg: api.fsDir+'/images/chat/chat-add.png'
	        },
	        keyboardBtn: {
	            normalImg: api.fsDir+'/images/chat/chat-keyboard.png'
	        },
	        speechBtn: {
	            normalImg: api.fsDir+'/images/chat/chat-record.png'
	        },
	        recordBtn: {
	            normalBg: '#ff7878',
	            activeBg: '#fac0c0',
	            color: '#fff',
	            size: 14
	        },
	        indicator: {
	            target: 'both',
	            color: '#c4c4c4',
	            activeColor: '#9e9e9e'
	        }
	    },
	    extras: {
	        btns: [{
	            title: '扔BB蛋',
	            normalImg: api.fsDir+'/images/chat/chat-egg.png'
	        }]
	    }
	}, function(ret){
	    //点击附加功能面板
	    if(ret.eventType == 'clickExtras'){
	        alert("用户点击了第"+ ret.index +"个按钮");
	    }
	    //点击发送按钮
	    if(ret.eventType == 'send'){
	    	doSendMsg(ret.msg);
	    }
	});
	
	// 监听输入框弹动事件
	chatBox.addEventListener({
		target : 'inputBar',
		name : 'move'
	}, function(ret, err) {
		setChatInit("chat_frm", ret.panelHeight + ret.inputBarHeight + (_isIOS() ? 0 : 10));
	});
	// 监听输入框改变事件
	chatBox.addEventListener({
		target : 'inputBar',
		name : 'change'
	}, function(ret, err) {
		setChatInit("chat_frm", ret.panelHeight + ret.inputBarHeight + (_isIOS() ? 0 : 10));
	});
}

function htmlEncode(str) {
    var div = document.createElement("div");
    div.appendChild(document.createTextNode(str));
    return div.innerHTML;
}
function htmlDecode(str) {
    var div = document.createElement("div");
    div.innerHTML = str;
    return div.innerHTML;
}
</script>

<span class="recvTemplate" style="display:none">
<li class="Y ">
    <div class="A">
        <span>船</span><!-- 头像 -->
    </div>
    <div class="B">
        <strong class="name">昵称</strong>
        <p class="msg">你瞅啥？</p>
    </div>
</li>
</span>
</body>
</html>