<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
<title>chat</title>
<meta name="description" content="">
<meta name="keywords" content="">
<link href="../css/reset.css" rel="stylesheet">
<link href="../css/style.css" rel="stylesheet">
<link href="../css/common.css" rel="stylesheet">
<script src="../js/jquery.min.js" type="text/javascript"></script>
<script src="../js/javascript.js" type="text/javascript"></script>
<script type="text/javascript">
var marginBottom="0px;";
apiready=function(){
	scrollTo();
	chatBox = api.require('UIChatBox');
	chatBox.open({
	    placeholder: '',
	    maxRows: 4,
	    emotionPath: 'widget://image/emotion',
	    texts: {
	        recordBtn: {
	            normalTitle: '按住 说话2',
	            activeTitle: '松开 结束'
	        }
	    },
	    styles: {
	        inputBar: {
	            borderColor: '#d9d9d9',
	            bgColor: '#f2f2f2'
	        },
	        inputBox: {
	            borderColor: '#B3B3B3',
	            bgColor: '#FFFFFF'
	        },
	        emotionBtn: {
	            normalImg: api.fsDir+'/images/chat/chat-emotion.png'
	        },
	        extrasBtn: {
	            normalImg: api.fsDir+'/images/chat/chat-add.png'
	        },
	        keyboardBtn: {
	            normalImg: api.fsDir+'/images/chat/chat-keyboard.png'
	        },
	        speechBtn: {
	            normalImg: api.fsDir+'/images/chat/chat-record.png'
	        },
	        recordBtn: {
	            normalBg: '#ff7878',
	            activeBg: '#fac0c0',
	            color: '#fff',
	            size: 14
	        },
	        indicator: {
	            target: 'both',
	            color: '#c4c4c4',
	            activeColor: '#9e9e9e'
	        }
	    },
	    extras: {
	        btns: [{
	            title: '扔BB蛋',
	            normalImg: api.fsDir+'/images/chat/chat-egg.png'
	        }]
	    }
	}, function(ret){
	    //点击附加功能面板
	    if(ret.eventType == 'clickExtras'){
	        alert("用户点击了第"+ ret.index +"个按钮");
	    }
	    //点击发送按钮
	    if(ret.eventType == 'send'){
	    	sendMsg(ret.msg);
	    }
	});
	
	chatBox.addEventListener({
        target: 'inputBar',
        name: 'move'
    }, function(ret,err){
    	//alert(JSON.stringify(ret));
		//api.pageDown({bottom: true, animate: true}, function (ret) {});
		//$('.mainer').css('margin-bottom' , '42px');
		//$('.mainer').scrollTop(999999999);
		//$('.mainer').scrollTop(999999999);
		var headerHeight = 50;
        var _h = ret.inputBarHeight + ret.panelHeight ;
        var h = api.winHeight - headerHeight - _h ;
        //alert(h);
//         api.setFrameAttr({
// 		    name: 'singleChat',
// 		    rect:{
// 		            x: 0 ,
// 		            y: headerHeight ,
// 		            w: 'auto',
// 		            h: h
// 		    }
// 		});
        $('.mainer').scrollTop(999999999);
	});
	
};
</script>
</head>
<body>
<div id="wrap" class="bodyer chat">
    
    <div id="mainer" class="mainer  vcenter">
        <ul class="chatList ing">
            <li class="Y">
                <div class="A">
                    <span>船</span>
                </div>
                <div class="B">
                    <strong>新船</strong>
                    <p>你瞅啥？</p>
                </div>
            </li>
            <li class="M">
                <div class="B">
                    <strong>御龙</strong>
                    <p>瞅你咋地~</p>
                </div>
                <div class="A">
                    <span>龙</span>
                </div>
            </li>
            <li class="Y">
                <div class="A">
                    <span>船</span>
                </div>
                <div class="B">
                    <strong>新船</strong>
                    <p>再瞅一个试试~</p>
                </div>
            </li>
            <li class="M">
                <div class="B">
                    <strong>御龙</strong>
                    <p>试试<br>就试试~</p>
                </div>
                <div class="A">
                    <span>龙</span>
                </div>
            </li>
            <li class="T">
                <div class="time">2015-11-16</div>
            </li>
            <li class="Y">
                <div class="A">
                    <span>船</span>
                </div>
                <div class="B">
                    <strong>新船</strong>
                    <p>你瞅啥？</p>
                </div>
            </li>
            <li class="M">
                <div class="B">
                    <strong>御龙</strong>
                    <p>瞅你咋地~</p>
                </div>
                <div class="A">
                    <span>龙</span>
                </div>
            </li>
            <li class="Y">
                <div class="A">
                    <span>船</span>
                </div>
                <div class="B">
                    <strong>新船</strong>
                    <p>再瞅一个试试~</p>
                </div>
            </li>
            <li class="M">
                <div class="B">
                    <strong>御龙</strong>
                    <p><img src="../images/2.jpg" class="face"><img src="../images/1.jpg">试试<br>就试试~就试试~就试试~就试试~就试试~就试试~就试试~就试试~就试试~就试试~</p>
                </div>
                <div class="A">
                    <span>龙</span>
                </div>
            </li>
            
            <li class="Y">
                <div class="A">
                    <span>船</span>
                </div>
                <div class="B">
                    <strong>新船</strong>
                    <p>你瞅啥？</p>
                </div>
            </li>
            <li class="M">
                <div class="B">
                    <strong>御龙</strong>
                    <p>瞅你咋地~</p>
                </div>
                <div class="A">
                    <span>龙</span>
                </div>
            </li>
            <li class="Y">
                <div class="A">
                    <span>船</span>
                </div>
                <div class="B">
                    <strong>新船</strong>
                    <p>再瞅一个试试~</p>
                </div>
            </li>
            <li class="M">
                <div class="B">
                    <strong>御龙</strong>
                    <p>试试<br>就试试~</p>
                </div>
                <div class="A">
                    <span>龙</span>
                </div>
            </li>
            <li class="T">
                <div class="time">2015-11-16</div>
            </li>
            <li class="Y">
                <div class="A">
                    <span>船</span>
                </div>
                <div class="B">
                    <strong>新船</strong>
                    <p>你瞅啥？</p>
                </div>
            </li>
            <li class="M">
                <div class="B">
                    <strong>御龙</strong>
                    <p>瞅你咋地~</p>
                </div>
                <div class="A">
                    <span>龙</span>
                </div>
            </li>
            <li class="Y">
                <div class="A">
                    <span>船</span>
                </div>
                <div class="B">
                    <strong>新船</strong>
                    <p>再瞅一个试试~</p>
                </div>
            </li>
            <li class="M">
                <div class="B">
                    <strong>御龙</strong>
                    <p><img src="../images/2.jpg" class="face"><img src="../images/1.jpg">试试<br>就试试~就试试~就试试~就试试~就试试~就试试~就试试~就试试~就试试~就试试~</p>
                </div>
                <div class="A">
                    <span>龙</span>
                </div>
            </li>
        </ul>
    </div>
    
    <div class="footer" style="display:none">
        <div class="chatBox" >
            <div class="l"><a href="#" class="btns btnExp"><i class="iconfont">&#xe65c;</i></a></div>
            <div class="c content" id="content" contenteditable="true"></div>
            <div class="r"><a href="#" class="btns submit" id="submit">发送</a></div>
        </div>
        <div class="chatExpBox">
            <ul class="expList clearfix">
                <li><img src="../images/2.jpg" alt=""></li>
                <li><img src="../images/1.jpg" alt=""></li>
            </ul>
        </div>
    </div>
</div>
<script type="text/javascript">
/* gotoScroll */
function scrollTo(a,t,callback){
    if(!a){a=$('.mainer')}
    //scrollTops=a.children(0).innerHeight() - a.innerHeight();
    //a.animate({scrollTop: 60},300,callback);
    a.scrollTop(99999);
}
/* Hv action */
function setHvData(name,value){
    if(window.localStorage){
        localStorage.setItem(name,value);
    }else{
        alert('不支持？');
    }
}
function getHvData(name){
    if(window.localStorage){
        return localStorage.getItem(name);
    }else{
        alert('不支持？');
    }
}
function reHvData(name){
    if(window.localStorage){
        return localStorage.removeItem(name);
    }else{
        alert('不支持？');
    }
}
/* 实时备份输入框内容 */
function contentIndexIng(){
    $('.content').on('input',function(){
        setHvData('me-you',$(this).html())
    })
}
/* 读取用户信息并显示在消息区 */
function contentSetVal(){
    var val=getHvData('me-you');
    if(val){$('.content').html(val)}
}
/* 删除用户信息 */
function contentReVal(){
    reHvData('me-you');
}

/* 判断文本框获取焦点 */
function ifContFocus(){
    var C=$('.content'),
    R=$('.submit');
    C.on('input',function(){
        if($(this).text()){
            R.addClass('focus');
        }else{
            R.removeClass('focus');
        }
    })
    if(C.text()){
        R.addClass('focus');
    }else{
        R.removeClass('focus');
    }
    C.focus();
    scrollTo();
}
$(document).ready(function() {

ifContFocus();
scrollTo();

contentIndexIng();
contentSetVal();
});


/* 聊天功能  */
var myName='御龙',
myFace='龙',
youName='',
youFace='';
function setChatList(v){
	v = v.replace(/div/g ,'span')
var str='<li class="M">'
    +'<div class="B">'
    +'<strong>'
    +myName
    +'</strong>'
    +'<p>'
    +v
    +'</p>'
    +'</div>'
    +'<div class="A">'
    +'<span>'
    +myFace
    +'</span>'
    +'</div>'
    +'</li>';
    return str;
}
$(document).on('click touch', '.submit', function(event) {
    var Thi=$(this),
    content=$('.content'),
    contentVal=content.html();
    if(contentVal){
        //layer.msg(content.val());
        var EnCodeVal=contentVal//HtmlEncode(contentVal);
        //alert(EnCodeVal)
        $('.mainer').children(0).append(setChatList(EnCodeVal))

        content.html('');
        content.focus();
        scrollTo();
        contentReVal();
    }
    event.preventDefault();
    /* Act on the event */
});

function sendMsg(msg){
	var content=$('.content');
	$('.mainer').children(0).append(setChatList(msg))
    //content.html('');
    //content.focus();
    scrollTo();
}



/* 表情图片区 */
function insertHtmlAtCaret(html) {
    if(html){
    var html=html;
    var sel, range;
    if (window.getSelection) {
        // IE9 and non-IE
        sel = window.getSelection();
        if (sel.getRangeAt && sel.rangeCount) {
            range = sel.getRangeAt(0);
            range.deleteContents();
            // Range.createContextualFragment() would be useful here but is
            // non-standard and not supported in all browsers (IE9, for one)
            var el = document.createElement("div.content");
            el.innerHTML = html;
            var frag = document.createDocumentFragment(), node, lastNode;
            while ( (node = el.firstChild) ) {
                lastNode = frag.appendChild(node);
            }
            range.insertNode(frag);
            // Preserve the selection
            if (lastNode) {
                range = range.cloneRange();
                range.setStartAfter(lastNode);
                range.collapse(true);
                sel.removeAllRanges();
                sel.addRange(range);
            }
        }
    }
    }
}
$(document).on('click touch', function(event) {
    $('.chatExpBox').removeClass('show');
});
$(document).on('click touch', '.btnExp,.chatExpBox', function(event) {
    var Thi=$(this),
    expBox=$('.chatExpBox'),
    content=$('.content');
    if(!expBox.hasClass('show')){
        expBox.addClass('show');
    }
    return false;
    event.preventDefault();
    /* Act on the event */
});
$(document).on('click touch', '.chatExpBox img', function(event) {
    var Thi=$(this),
    content=$('.content'),
    faces=Thi.prop("outerHTML");
//    layer.msg(Thi.attr('src'));
//content.val(Thi.prop("outerHTML"))
insertHtmlAtCaret(faces)
    return false;
    event.preventDefault();
    /* Act on the event */
});




</script>
</body>
</html>